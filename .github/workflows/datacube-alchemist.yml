name: Lint, Test Code and Push Image

on: [push]

jobs:
  main:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Build the docker container
      run: |
        docker-compose build

    - name: Bring up the docker container
      run: |
        docker-compose up -d

    - name: Run tests
      run: |
        docker-compose exec -T alchemist pytest tests

    - name: Get the git tag
      run: |
        git fetch --tags
        echo ::set-env name=GITTAG::$(git describe --tag)
        echo $GITTAG

    - name: Build and Push unstable Docker Image from PR
      uses: whoan/docker-build-with-cache-action@v4
      if: github.ref == 'refs/heads/master'
      with:
        image_name: ${{ env.IMAGE_NAME }}
        username: "${{ secrets.DOCKER_USER }}"
        password: "${{ secrets.DOCKER_PASS }}"
        image_tag: latest,${{ env.GITTAG }}
        build_extra_args: "--build-arg=ENVIRONMENT=deployment"
